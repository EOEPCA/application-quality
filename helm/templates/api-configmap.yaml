apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "application-quality.fullname" . }}-api-env
data:
  BACKEND_SERVICE_HOST: {{ include "application-quality.fullname" . }}-api.{{ .Release.Namespace }}.svc.cluster.local
  BACKEND_SERVICE_PORT: {{ .Values.api.containerPort | quote }}

  # Database
  DB_NAME: {{ .Values.db.name }}
  DB_HOST: {{ include "application-quality.fullname" . }}-db
  DB_PORT: {{ .Values.db.containerPort | quote }}
  # TODO: From secret
  DB_USER: {{ .Values.db.user }}
  DB_PASSWORD: {{ .Values.db.password | quote }}

  # Opensearch
  OPENSEARCH_ENABLED: {{ .Values.opensearch.enabled | default false | quote }}
  OPENSEARCH_URL: {{ .Values.opensearch.url }}
  OPENSEARCH_INDEX_RUNS: {{ .Values.opensearch.indexRuns | default "application-quality-pipeline-runs" }}
  OPENSEARCH_INDEX_REPORTS: {{ .Values.opensearch.indexReports | default "application-quality-pipeline-run-reports" }}
  # TODO: From secret
  OPENSEARCH_USERNAME: {{ .Values.opensearch.username }}
  OPENSEARCH_PASSWORD: {{ .Values.opensearch.password | quote }}

  # TBD
  AQBB_STORAGECLASS: {{ .Values.calrissian.storageClassName }}
  AQBB_VOLUMESIZE: {{ .Values.calrissian.volumeSize | quote }}
  AQBB_CALRISSIANIMAGE: {{ .Values.calrissian.image }}
  AQBB_MAXCORES: {{ .Values.calrissian.maxCores | quote }}
  AQBB_MAXRAM: {{ .Values.calrissian.maxRam | quote }}

  OIDC_ENABLED: {{ .Values.oidc.enabled | default false | quote }}
  {{- if eq .Values.oidc.enabled true }}
  # From Sealed Secret: OIDC_RP_CLIENT_ID: {{ .Values.oidc.clientId }}
  # From Sealed Secret: OIDC_RP_CLIENT_SECRET: {{ .Values.oidc.clientSecret }}
  OIDC_CONNECT_CONFIG_URL: {{ .Values.oidc.realmBaseUrl }}/.well-known/openid-configuration
  LOGIN_URL: {{ .Values.oidc.loginUrl }}
  LOGIN_REDIRECT_URL: {{ .Values.oidc.loginRedirectUrl }}
  LOGOUT_REDIRECT_URL: {{ .Values.oidc.logoutRedirectUrl }}
  OIDC_RP_REDIRECT_URI: {{ .Values.oidc.rpRedirectUri }}
  OIDC_RP_SIGN_ALGO: {{ .Values.oidc.rpSignAlgo }}
  OIDC_LOGOUT_ENDPOINT_PATH: {{ .Values.oidc.logoutEndpointPath }}
  OIDC_LOGOUT_REDIRECT_URI_PARAMETER_NAME: {{ .Values.oidc.logoutRedirectUrlParameterName }}
  OIDC_POST_LOGOUT_REDIRECT_URL: {{ .Values.oidc.postLogoutRedirectUrl }}
  # TODO: The following values must be obtained from the OpenID configuration
  OIDC_OP_AUTHORIZATION_ENDPOINT: {{ .Values.oidc.realmBaseUrl }}/protocol/openid-connect/auth
  OIDC_OP_TOKEN_ENDPOINT: {{ .Values.oidc.realmBaseUrl }}/protocol/openid-connect/token
  OIDC_OP_USER_ENDPOINT: {{ .Values.oidc.realmBaseUrl }}/protocol/openid-connect/userinfo
  OIDC_OP_JWKS_ENDPOINT: {{ .Values.oidc.realmBaseUrl }}/protocol/openid-connect/certs
  {{- end }}
  {{- if eq .Values.sonarqube.enabled true }}
  SONARQUBE_SERVER: {{ .Values.sonarqube.serverUrl }}
  SONARQUBE_TOKEN: {{ .Values.sonarqube.accessToken }}
  {{- end }}